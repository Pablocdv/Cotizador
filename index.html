<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cotizador de Carteles - FIX LOCAL</title>
    <style>
        :root{--yellow:#ffd400;--black:#111;--plate:#f7f7f7}
        body { font-family: Inter, system-ui, -apple-system, Roboto, 'Helvetica Neue', Arial; background: var(--plate); display: flex; justify-content: center; padding: 24px; }
        .card { background: white; padding: 18px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.14); width: 100%; max-width: 980px; }
        .sign-header{ background: repeating-linear-gradient(45deg, var(--yellow) 0 12px, var(--black) 12px 24px); color: var(--black); padding: 10px 16px; border-radius: 8px; display:flex; align-items:center; gap:12px; margin-bottom:14px }
        .sign-title{ font-weight:800; font-size:20px; color:#111; text-transform:uppercase; letter-spacing:1px }
        .config-panel { background: rgba(0,0,0,0.04); padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 13px; border: 1px solid rgba(0,0,0,0.06); }
        label { display: block; margin: 8px 0 6px; font-weight: 700; font-size:13px }
        select, input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        .controls { display:flex; gap:12px; align-items:flex-start }
        .left { flex: 1; }
        .right { width: 420px; }
        .result { background: linear-gradient(180deg,#fff 0,#fff); padding: 18px; border-radius: 10px; text-align: center; border: 2px solid rgba(0,0,0,0.06); margin: 12px 0; }
        .price { font-size: 30px; font-weight: 800; color: var(--black); }
        .btn-sync { background: var(--black); color: var(--yellow); border: none; padding: 10px; border-radius: 6px; cursor: pointer; width: 100%; margin-bottom: 10px; font-weight:700 }
        .btn-ws { background: var(--yellow); color: var(--black); border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: 800; cursor: pointer; font-size: 15px; box-shadow: 0 6px 18px rgba(0,0,0,0.08) }
        table.precios{ width:100%; border-collapse: collapse; margin-top: 10px }
        table.precios th{ background: var(--black); color: var(--yellow); padding:10px; text-align:left; font-weight:800 }
        table.precios td{ padding:10px; border-bottom:1px dashed #eee }
        table.precios tr:nth-child(even) td{ background: #fffdfa }
        .small { font-size:12px; color:#666 }
    </style>
</head>
<body>

<div class="card">
    <div class="sign-header">
        <div class="sign-title">COTIZADOR - Se√±alizaci√≥n Vial</div>
        <div class="small">Carga desde el CSV p√∫blico y muestra todos los AUT/Precios</div>
    </div>

    <div class="controls">
        <div class="left">
            <div class="config-panel">
                <strong>‚ö†Ô∏è Si no carga autom√°tico:</strong><br>
                1. Haz clic en el bot√≥n negro de abajo.<br>
                2. Si falla, puede ser bloqueo CORS.
                <button class="btn-sync" onclick="cargarDatos()">üîÑ FORZAR CARGA DE PRECIOS</button>
                <div id="manualArea" style="margin-top:10px; display:none">
                    <div class="small">Si la carga remota falla, pega aqu√≠ el contenido CSV o sube el archivo:</div>
                    <textarea id="csvPaste" style="width:100%;height:80px;margin-top:6px;border-radius:6px;padding:8px;border:1px solid #ddd" placeholder="Pega aqu√≠ el CSV... (Ctrl+V)"></textarea>
                    <input type="file" id="csvFile" accept=".csv,text/csv" style="margin-top:8px">
                    <button class="btn-sync" onclick="loadFromPaste()" style="margin-top:8px;background:#444;color:var(--yellow)">Cargar desde texto</button>
                </div>
            </div>

            <label>D√≥lar ($)</label>
            <input type="number" id="dolar" value="1550" oninput="actualizarTabla()">

            <label>Material (selecci√≥n r√°pida)</label>
            <select id="materialSelect" onchange="calcular()">
                <option>Esperando carga...</option>
            </select>

            <div style="display:flex; gap:10px;">
                <input type="number" id="ancho" placeholder="Ancho cm" oninput="calcular()">
                <input type="number" id="alto" placeholder="Alto cm" oninput="calcular()">
            </div>

            <div class="result">
                <div id="matNombre" style="font-weight:bold">-</div>
                <div class="price" id="precioFinal">$ 0,00</div>
            </div>

            <button class="btn-ws" onclick="enviarWS()">Enviar WhatsApp</button>
        </div>

        <div class="right">
            <label>Lista de AUT y Precios</label>
            <div class="small">Se muestran todos los pares `AUT` + precio (USD) encontrados en el CSV.</div>
            <table class="precios" id="preciosTable">
                <thead><tr><th>AUT</th><th>Precio (USD)</th><th>Precio (ARS)</th></tr></thead>
                <tbody><tr><td colspan="3" class="small">Cargando...</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOf98asUFDCGY2gRpbbMmB3KQyWbZbZcDv7FAhxp5lTvvRuZegS9AdhnwKNVRBldvHPsCEgecllMyT/pub?gid=0&single=true&output=csv";

    // Parser CSV simple pero que maneja comillas y comas internas
    function parseCSV(text) {
        const rows = [];
        const re = /(?:\s*\n|\r\n|\n|\r|^)(?:"((?:[^"]|"" )*)"|([^",\r\n]*))(?:,|$)/g;
        let row = [];
        let match;
        let idx = 0;
        while ((match = re.exec(text)) !== null) {
            const quoted = match[1];
            const unquoted = match[2];
            const val = quoted !== undefined ? quoted.replace(/""/g, '"') : (unquoted || '');
            row.push(val);
            const nextChar = text[re.lastIndex - 1];
            if (nextChar === '\n' || nextChar === '\r') { rows.push(row); row = []; }
            if (++idx > 1000000) break;
        }
        if (row.length) rows.push(row);
        return rows;
    }

    async function cargarDatos() {
        const select = document.getElementById("materialSelect");
        select.innerHTML = "<option>Cargando...</option>";
        const proxyRaw = "https://api.allorigins.win/raw?url=" + encodeURIComponent(urlCSV);
        const proxyThing = "https://thingproxy.freeboard.io/fetch/" + urlCSV;
        const proxyJina = "https://r.jina.ai/http/" + urlCSV;
        const proxies = [proxyRaw, proxyThing, proxyJina, urlCSV];
        let text = null;
        for (const p of proxies) {
            try { const res = await fetch(p); if (!res.ok) throw new Error('status ' + res.status); text = await res.text(); break; } catch (e) {}
        }
        if (!text) { select.innerHTML = "<option>Error al cargar</option>"; document.getElementById('manualArea').style.display = 'block'; return; }

        const filas = parseCSV(text);
        const headers = (filas[0] || []).map(h => (h||'').toString().trim());
        const pairs = [];
        for (let i = 0; i < headers.length; i++) if (/aut/i.test(headers[i])) pairs.push({ autIndex: i, priceIndex: i+1 });
        const preciosList = [];
        if (pairs.length === 0) {
            for (let r = 6; r < filas.length; r++) { const f = filas[r]; if (!f) continue; const nombre = (f[6] || f[0] || '').trim(); const precio = parseFloat((f[10] || f[1] || '0').toString().replace(/[^0-9\.,-]/g,'').replace(',', '.')) || 0; if (nombre && precio>0) preciosList.push({ aut: nombre, priceUSD: precio }); }
        } else {
            for (let r = 1; r < filas.length; r++) { const row = filas[r]; if (!row) continue; for (const p of pairs) { const aut = (row[p.autIndex]||'').toString().trim(); let priceUSD = 0; if (row[p.priceIndex]!==undefined) priceUSD = parseFloat(row[p.priceIndex].toString().replace(/[^0-9\.,-]/g,'').replace(',', '.')) || 0; if (aut && priceUSD>0) preciosList.push({aut, priceUSD}); } }
        }
        if (preciosList.length === 0) { select.innerHTML = "<option>No se encontraron materiales</option>"; alert('‚ö†Ô∏è No se encontraron pares AUT+Precio en el CSV.'); return; }

        const tbody = document.querySelector('#preciosTable tbody'); tbody.innerHTML=''; const firstByAut = new Map(); preciosList.forEach(item=>{ const tr=document.createElement('tr'); const tdAut=document.createElement('td'); tdAut.textContent=item.aut; tr.appendChild(tdAut); const tdUsd=document.createElement('td'); tdUsd.textContent=Number(item.priceUSD).toLocaleString('en-US',{minimumFractionDigits:2}); tr.appendChild(tdUsd); const tdArs=document.createElement('td'); tdArs.textContent='‚Äî'; tdArs.dataset.usd=item.priceUSD; tr.appendChild(tdArs); tbody.appendChild(tr); if (!firstByAut.has(item.aut)) firstByAut.set(item.aut,item.priceUSD); });
        select.innerHTML=''; firstByAut.forEach((price,aut)=>{ const opt=document.createElement('option'); opt.value=price; opt.textContent=aut; select.appendChild(opt); });
        actualizarTabla(); calcular();
    }

    function actualizarTabla(){ const dolar=parseFloat(document.getElementById('dolar').value)||0; const rows=document.querySelectorAll('#preciosTable tbody tr'); rows.forEach(r=>{ const tdArs=r.children[2]; const usd=parseFloat(tdArs.dataset.usd||tdArs.textContent.replace(/[^0-9\.,-]/g,'').replace(',','.'))||0; const ars=usd*dolar; tdArs.textContent=ars?('$ '+ars.toLocaleString('es-AR',{minimumFractionDigits:2})):'‚Äî'; }); }

    function calcular(){ const dolar=parseFloat(document.getElementById('dolar').value)||0; const priceUSD=parseFloat(document.getElementById('materialSelect').value)||0; const anc=parseFloat(document.getElementById('ancho').value)||0; const alt=parseFloat(document.getElementById('alto').value)||0; const area=(anc>0&&alt>0)?((anc/100)*(alt/100)):1; const totalARS=priceUSD*dolar*area; document.getElementById('precioFinal').textContent='$ '+totalARS.toLocaleString('es-AR',{minimumFractionDigits:2}); const s=document.getElementById('materialSelect'); document.getElementById('matNombre').textContent=s.options[s.selectedIndex]?s.options[s.selectedIndex].text:'-'; }

    function enviarWS(){ const material=document.getElementById('matNombre').textContent; const ancho=document.getElementById('ancho').value||'-'; const alto=document.getElementById('alto').value||'-'; const total=document.getElementById('precioFinal').textContent; const msj=`*Presupuesto*%0A*Material:* ${material}%0A*Medidas:* ${ancho}x${alto} cm%0A*Total:* ${total}`; window.open(`https://wa.me/?text=${msj}`); }

    window.onload = cargarDatos;

    // Carga desde texto pegado o archivo (parity with cotizador.html)
    function loadFromPaste() {
        const txt = document.getElementById('csvPaste').value;
        if (!txt || txt.trim().length === 0) { alert('Pega el CSV en el cuadro antes de cargar.'); return; }
        loadFromText(txt);
    }

    document.getElementById('csvFile')?.addEventListener('change', function(e){
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = function(){ loadFromText(r.result); }
        r.readAsText(f,'UTF-8');
    });

    function loadFromText(text) {
        try {
            const filas = parseCSV(text);
            const headers = (filas[0] || []).map(h => (h||'').toString().trim());
            const pairs = [];
            for (let i = 0; i < headers.length; i++) if (/aut/i.test(headers[i])) pairs.push({ autIndex: i, priceIndex: i+1 });
            const preciosList = [];
            if (pairs.length === 0) {
                for (let r = 6; r < filas.length; r++) { const f = filas[r]; if (!f) continue; const nombre = (f[6] || f[0] || '').trim(); const precio = parseFloat((f[10] || f[1] || '0').toString().replace(/[^0-9\.,-]/g,'').replace(',', '.')) || 0; if (nombre && precio>0) preciosList.push({ aut: nombre, priceUSD: precio }); }
            } else {
                for (let r = 1; r < filas.length; r++) { const row = filas[r]; if (!row) continue; for (const p of pairs) { const aut = (row[p.autIndex]||'').toString().trim(); let priceUSD = 0; if (row[p.priceIndex]!==undefined) priceUSD = parseFloat(row[p.priceIndex].toString().replace(/[^0-9\.,-]/g,'').replace(',', '.')) || 0; if (aut && priceUSD>0) preciosList.push({aut, priceUSD}); } }
            }
            if (preciosList.length === 0) { alert('No se encontraron pares AUT+Precio en el CSV pegado.'); return; }
            const select = document.getElementById('materialSelect');
            const tbody = document.querySelector('#preciosTable tbody'); tbody.innerHTML=''; const firstByAut = new Map(); preciosList.forEach(item=>{ const tr=document.createElement('tr'); const tdAut=document.createElement('td'); tdAut.textContent=item.aut; tr.appendChild(tdAut); const tdUsd=document.createElement('td'); tdUsd.textContent=Number(item.priceUSD).toLocaleString('en-US',{minimumFractionDigits:2}); tr.appendChild(tdUsd); const tdArs=document.createElement('td'); tdArs.textContent='‚Äî'; tdArs.dataset.usd=item.priceUSD; tr.appendChild(tdArs); tbody.appendChild(tr); if (!firstByAut.has(item.aut)) firstByAut.set(item.aut,item.priceUSD); });
            select.innerHTML=''; firstByAut.forEach((price,aut)=>{ const opt=document.createElement('option'); opt.value=price; opt.textContent=aut; select.appendChild(opt); });
            actualizarTabla(); calcular();
            document.getElementById('manualArea').style.display = 'none';
        } catch (e) { alert('Error procesando CSV: '+e.message); }
    }
</script>
</body>
</html>
