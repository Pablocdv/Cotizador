<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cotizador de Carteles - FIX LOCAL</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        h2 { color: #1a73e8; text-align: center; margin-top: 0; }
        .config-panel { background: #fff3cd; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 12px; border: 1px solid #ffeeba; }
        label { display: block; margin: 10px 0 5px; font-weight: bold; }
        select, input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .result { background: #e8f0fe; padding: 20px; border-radius: 10px; text-align: center; border: 2px solid #1a73e8; margin: 15px 0; }
        .price { font-size: 32px; font-weight: bold; color: #1a73e8; }
        .btn-sync { background: #1a73e8; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; margin-bottom: 10px; }
        .btn-ws { background: #25d366; color: white; border: none; padding: 15px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Cotizador Pro</h2>
    
    <div class="config-panel">
        <strong>‚ö†Ô∏è Si no carga autom√°tico:</strong><br>
        1. Haz clic en el bot√≥n azul de abajo.<br>
        2. Si falla, es bloqueo de tu PC.
        <button class="btn-sync" onclick="cargarDatos()">üîÑ FORZAR CARGA DE PRECIOS</button>
    </div>

    <label>D√≥lar ($)</label>
    <input type="number" id="dolar" value="1550" oninput="calcular()">

    <label>Material</label>
    <select id="materialSelect" onchange="calcular()">
        <option>Esperando carga...</option>
    </select>

    <div style="display:flex; gap:10px;">
        <input type="number" id="ancho" placeholder="Ancho cm" oninput="calcular()">
        <input type="number" id="alto" placeholder="Alto cm" oninput="calcular()">
    </div>

    <div class="result">
        <div id="matNombre" style="font-weight:bold">-</div>
        <div class="price" id="precioFinal">$ 0,00</div>
    </div>

    <button class="btn-ws" onclick="enviarWS()">Enviar WhatsApp</button>
</div>

<script>
    const urlCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQOf98asUFDCGY2gRpbbMmB3KQyWbZbZcDv7FAhxp5lTvvRuZegS9AdhnwKNVRBldvHPsCEgecllMyT/pub?gid=0&single=true&output=csv";

    // Parser CSV simple pero que maneja comillas y comas internas
    function parseCSV(text) {
        const rows = [];
        const re = /(?:\s*\n|\r\n|\n|\r|^)(?:"((?:[^"]|"")*)"|([^",\r\n]*))(?:,|$)/g;
        let row = [];
        let match;
        let idx = 0;
        while ((match = re.exec(text)) !== null) {
            const quoted = match[1];
            const unquoted = match[2];
            const val = quoted !== undefined ? quoted.replace(/""/g, '"') : (unquoted || '');
            row.push(val);
            // If the match ended with a newline, push row and reset
            const nextChar = text[re.lastIndex - 1];
            if (nextChar === '\n' || nextChar === '\r') {
                rows.push(row);
                row = [];
            }
            // safety to avoid infinite loop
            if (++idx > 1000000) break;
        }
        if (row.length) rows.push(row);
        return rows;
    }

    async function cargarDatos() {
        const select = document.getElementById("materialSelect");
        select.innerHTML = "<option>Cargando...</option>";

        // Intentamos usar AllOrigins/raw para evitar problemas CORS
        const proxyRaw = "https://api.allorigins.win/raw?url=" + encodeURIComponent(urlCSV);
        const proxies = [proxyRaw, urlCSV];

        let text = null;
        for (const p of proxies) {
            try {
                const res = await fetch(p);
                if (!res.ok) throw new Error('status ' + res.status);
                text = await res.text();
                break;
            } catch (e) {
                // sigue al siguiente proxy
            }
        }

        if (!text) {
            select.innerHTML = "<option>Error al cargar</option>";
            alert("‚ùå No fue posible cargar el CSV desde Google (CORS o bloqueo).\n\nSugerencia: publica este archivo en GitHub Pages y usa la URL https://TU_USUARIO.github.io/TU_REPO/cotizador.html");
            return;
        }

        const filas = parseCSV(text);
        // Si la hoja tiene encabezados y filas de info, buscar columnas por √≠ndice seguro
        // Intentamos leer nombre en columna 7 y precio en columna 11 (base anterior). Si no, tomamos columnas 0 y 1.
        const materiales = [];
        for (let i = 6; i < filas.length; i++) {
            const f = filas[i];
            if (!f) continue;
            const nombre = (f[6] || f[0] || "").trim();
            const precio = parseFloat((f[10] || f[1] || "0").replace(/[^0-9\.,-]/g, '').replace(',', '.')) || 0;
            if (nombre && precio > 0) materiales.push({ nombre, precioPesos: precio });
        }

        if (materiales.length === 0) {
            select.innerHTML = "<option>No se encontraron materiales</option>";
            alert('‚ö†Ô∏è No se encontraron materiales v√°lidos en el CSV.');
            return;
        }

        select.innerHTML = "";
        materiales.forEach(m => {
            let opt = document.createElement("option");
            opt.value = m.precioPesos;
            opt.textContent = m.nombre;
            select.appendChild(opt);
        });
        calcular();
    }

    function calcular() {
        const d = parseFloat(document.getElementById("dolar").value) || 0;
        const v = parseFloat(document.getElementById("materialSelect").value) || 0;
        const anc = parseFloat(document.getElementById("ancho").value) || 0;
        const alt = parseFloat(document.getElementById("alto").value) || 0;
        
        // Ajuste proporcional si cambias el d√≥lar manual respecto al del Excel (1550)
        const total = (anc/100) * (alt/100) * v * (d/1550);
        
        document.getElementById("precioFinal").textContent = "$ " + total.toLocaleString('es-AR', {minimumFractionDigits:2});
        const s = document.getElementById("materialSelect");
        document.getElementById("matNombre").textContent = s.options[s.selectedIndex].text;
    }

    function enviarWS() {
        const msj = `*Presupuesto*%0A*Material:* ${document.getElementById("matNombre").textContent}%0A*Medidas:* ${document.getElementById("ancho").value}x${document.getElementById("alto").value}cm%0A*Total:* ${document.getElementById("precioFinal").textContent}`;
        window.open(`https://wa.me/?text=${msj}`);
    }

    // Intentar carga inicial
    window.onload = cargarDatos;
</script>
</body>
</html>